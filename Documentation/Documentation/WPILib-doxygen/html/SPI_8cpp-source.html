<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>WPILIB: SPI.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>SPI.cpp</h1><a href="SPI_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*----------------------------------------------------------------------------*/</span>
<a name="l00002"></a>00002 <span class="comment">/* Copyright (c) FIRST 2008. All Rights Reserved.                             */</span>
<a name="l00003"></a>00003 <span class="comment">/* Open Source Software - may be modified and shared by FRC teams. The code   */</span>
<a name="l00004"></a>00004 <span class="comment">/* must be accompanied by the FIRST BSD license file in $(WIND_BASE)/WPILib.  */</span>
<a name="l00005"></a>00005 <span class="comment">/*----------------------------------------------------------------------------*/</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="preprocessor">#include "<a class="code" href="SPI_8h.html">SPI.h</a>"</span>
<a name="l00008"></a>00008 
<a name="l00009"></a>00009 <span class="preprocessor">#include "ChipObject/tSPI.h"</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include "<a class="code" href="DigitalInput_8h.html">DigitalInput.h</a>"</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include "<a class="code" href="DigitalOutput_8h.html">DigitalOutput.h</a>"</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include "<a class="code" href="Synchronized_8h.html">Synchronized.h</a>"</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include "<a class="code" href="Utility_8h.html">Utility.h</a>"</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include "<a class="code" href="WPIStatus_8h.html">WPIStatus.h</a>"</span>
<a name="l00015"></a>00015 
<a name="l00016"></a>00016 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &lt;usrLib.h&gt;</span>
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 SEM_ID <a class="code" href="classSPI.html#5526fc62f7ed652c65ab9e4a5f778062">SPI::m_semaphore</a> = <a class="code" href="nivision_8h.html#070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00020"></a>00020 
<a name="l00030"></a><a class="code" href="classSPI.html#b8a031abcb911915f2221324211f37b4">00030</a> <a class="code" href="classSPI.html#b8a031abcb911915f2221324211f37b4">SPI::SPI</a>(<a class="code" href="classDigitalOutput.html">DigitalOutput</a> &amp;clk, <a class="code" href="classDigitalOutput.html">DigitalOutput</a> &amp;mosi, <a class="code" href="classDigitalInput.html">DigitalInput</a> &amp;miso)
<a name="l00031"></a>00031 {
<a name="l00032"></a>00032     <a class="code" href="classSPI.html#3c0dc0985f8040016ad30ea1fd237fa1">Init</a>(&amp;clk, &amp;mosi, &amp;miso);
<a name="l00033"></a>00033 }
<a name="l00034"></a>00034 
<a name="l00044"></a><a class="code" href="classSPI.html#5a9ff16c1b36056d2bab48c8bb9dd58f">00044</a> <a class="code" href="classSPI.html#b8a031abcb911915f2221324211f37b4">SPI::SPI</a>(<a class="code" href="classDigitalOutput.html">DigitalOutput</a> *clk, <a class="code" href="classDigitalOutput.html">DigitalOutput</a> *mosi, <a class="code" href="classDigitalInput.html">DigitalInput</a> *miso)
<a name="l00045"></a>00045 {
<a name="l00046"></a>00046     <a class="code" href="classSPI.html#3c0dc0985f8040016ad30ea1fd237fa1">Init</a>(clk, mosi, miso);
<a name="l00047"></a>00047 }
<a name="l00048"></a>00048 
<a name="l00056"></a><a class="code" href="classSPI.html#a99a1d66d364cb0ec749026660fb8bd2">00056</a> <a class="code" href="classSPI.html#b8a031abcb911915f2221324211f37b4">SPI::SPI</a>(<a class="code" href="classDigitalOutput.html">DigitalOutput</a> &amp;clk, <a class="code" href="classDigitalOutput.html">DigitalOutput</a> &amp;mosi)
<a name="l00057"></a>00057 {
<a name="l00058"></a>00058     <a class="code" href="classSPI.html#3c0dc0985f8040016ad30ea1fd237fa1">Init</a>(&amp;clk, &amp;mosi, <a class="code" href="nivision_8h.html#070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00059"></a>00059 }
<a name="l00060"></a>00060 
<a name="l00068"></a><a class="code" href="classSPI.html#8de2c7b9a8484df3e4588afa5ed47178">00068</a> <a class="code" href="classSPI.html#b8a031abcb911915f2221324211f37b4">SPI::SPI</a>(<a class="code" href="classDigitalOutput.html">DigitalOutput</a> *clk, <a class="code" href="classDigitalOutput.html">DigitalOutput</a> *mosi)
<a name="l00069"></a>00069 {
<a name="l00070"></a>00070     <a class="code" href="classSPI.html#3c0dc0985f8040016ad30ea1fd237fa1">Init</a>(clk, mosi, <a class="code" href="nivision_8h.html#070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00071"></a>00071 }
<a name="l00072"></a>00072 
<a name="l00080"></a><a class="code" href="classSPI.html#1ff8fa9eb4cf60ec5238c5797651afec">00080</a> <a class="code" href="classSPI.html#b8a031abcb911915f2221324211f37b4">SPI::SPI</a>(<a class="code" href="classDigitalOutput.html">DigitalOutput</a> &amp;clk, <a class="code" href="classDigitalInput.html">DigitalInput</a> &amp;miso)
<a name="l00081"></a>00081 {
<a name="l00082"></a>00082     <a class="code" href="classSPI.html#3c0dc0985f8040016ad30ea1fd237fa1">Init</a>(&amp;clk, <a class="code" href="nivision_8h.html#070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;miso);
<a name="l00083"></a>00083 }
<a name="l00084"></a>00084 
<a name="l00092"></a><a class="code" href="classSPI.html#74dd16adaa9ca26845ebc2f8c61379fa">00092</a> <a class="code" href="classSPI.html#b8a031abcb911915f2221324211f37b4">SPI::SPI</a>(<a class="code" href="classDigitalOutput.html">DigitalOutput</a> *clk, <a class="code" href="classDigitalInput.html">DigitalInput</a> *miso)
<a name="l00093"></a>00093 {
<a name="l00094"></a>00094     <a class="code" href="classSPI.html#3c0dc0985f8040016ad30ea1fd237fa1">Init</a>(clk, <a class="code" href="nivision_8h.html#070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, miso);
<a name="l00095"></a>00095 }
<a name="l00096"></a>00096 
<a name="l00100"></a><a class="code" href="classSPI.html#6babebf1ea3e8ff0330f43a3e2312ac4">00100</a> <a class="code" href="classSPI.html#6babebf1ea3e8ff0330f43a3e2312ac4">SPI::~SPI</a>()
<a name="l00101"></a>00101 {
<a name="l00102"></a>00102     <span class="keyword">delete</span> <a class="code" href="classSPI.html#2e51fd2a5f60a207e1948fcce6ce4b6a">m_spi</a>;
<a name="l00103"></a>00103 }
<a name="l00104"></a>00104 
<a name="l00114"></a><a class="code" href="classSPI.html#3c0dc0985f8040016ad30ea1fd237fa1">00114</a> <span class="keywordtype">void</span> <a class="code" href="classSPI.html#3c0dc0985f8040016ad30ea1fd237fa1">SPI::Init</a>(<a class="code" href="classDigitalOutput.html">DigitalOutput</a> *clk, <a class="code" href="classDigitalOutput.html">DigitalOutput</a> *mosi, <a class="code" href="classDigitalInput.html">DigitalInput</a> *miso)
<a name="l00115"></a>00115 {
<a name="l00116"></a>00116     <span class="keywordflow">if</span> (<a class="code" href="classSPI.html#5526fc62f7ed652c65ab9e4a5f778062">m_semaphore</a> == <a class="code" href="nivision_8h.html#070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00117"></a>00117     {
<a name="l00118"></a>00118         <a class="code" href="classSPI.html#5526fc62f7ed652c65ab9e4a5f778062">m_semaphore</a> = semMCreate(SEM_Q_PRIORITY | SEM_DELETE_SAFE | SEM_INVERSION_SAFE);
<a name="l00119"></a>00119     }
<a name="l00120"></a>00120 
<a name="l00121"></a>00121     <a class="code" href="classSPI.html#2e51fd2a5f60a207e1948fcce6ce4b6a">m_spi</a> = <span class="keyword">new</span> tSPI(&amp;<a class="code" href="classErrorBase.html#94cef1c4df1d6def498a2b3c458408c4">status</a>);
<a name="l00122"></a>00122     <a class="code" href="Utility_8h.html#8dd3b031e36607585b844aef60f80f6d">wpi_assertCleanStatus</a>(<a class="code" href="classErrorBase.html#94cef1c4df1d6def498a2b3c458408c4">status</a>);
<a name="l00123"></a>00123 
<a name="l00124"></a>00124     <a class="code" href="classSPI.html#246566dd89a56e47235573fa1cbf4650">m_config</a>.BusBitWidth = 8;
<a name="l00125"></a>00125     <a class="code" href="classSPI.html#246566dd89a56e47235573fa1cbf4650">m_config</a>.ClockHalfPeriodDelay = 0;
<a name="l00126"></a>00126     <a class="code" href="classSPI.html#246566dd89a56e47235573fa1cbf4650">m_config</a>.MSBfirst = 0;
<a name="l00127"></a>00127     <a class="code" href="classSPI.html#246566dd89a56e47235573fa1cbf4650">m_config</a>.DataOnFalling = 0;
<a name="l00128"></a>00128     <a class="code" href="classSPI.html#246566dd89a56e47235573fa1cbf4650">m_config</a>.LatchFirst = 0;
<a name="l00129"></a>00129     <a class="code" href="classSPI.html#246566dd89a56e47235573fa1cbf4650">m_config</a>.LatchLast = 0;
<a name="l00130"></a>00130     <a class="code" href="classSPI.html#246566dd89a56e47235573fa1cbf4650">m_config</a>.FramePolarity = 0;
<a name="l00131"></a>00131     <a class="code" href="classSPI.html#246566dd89a56e47235573fa1cbf4650">m_config</a>.WriteOnly = miso ? 0 : 1;
<a name="l00132"></a>00132     <a class="code" href="classSPI.html#246566dd89a56e47235573fa1cbf4650">m_config</a>.ClockPolarity = 0;
<a name="l00133"></a>00133 
<a name="l00134"></a>00134     <a class="code" href="classSPI.html#400f5597cc5fa5d5ec4e53b16e7e563a">m_channels</a>.SCLK_Channel = clk-&gt;<a class="code" href="classDigitalOutput.html#51540582af4f1ebb04c19e0256e0cbfd">GetChannelForRouting</a>();
<a name="l00135"></a>00135     <a class="code" href="classSPI.html#400f5597cc5fa5d5ec4e53b16e7e563a">m_channels</a>.SCLK_Module = clk-&gt;<a class="code" href="classDigitalOutput.html#a32b0d9370a8dca3970a09b38d0bb434">GetModuleForRouting</a>();
<a name="l00136"></a>00136     <a class="code" href="classSPI.html#400f5597cc5fa5d5ec4e53b16e7e563a">m_channels</a>.SS_Channel = 0;
<a name="l00137"></a>00137     <a class="code" href="classSPI.html#400f5597cc5fa5d5ec4e53b16e7e563a">m_channels</a>.SS_Module = 0;
<a name="l00138"></a>00138 
<a name="l00139"></a>00139     <span class="keywordflow">if</span> (mosi)
<a name="l00140"></a>00140     {
<a name="l00141"></a>00141         <a class="code" href="classSPI.html#400f5597cc5fa5d5ec4e53b16e7e563a">m_channels</a>.MOSI_Channel = mosi-&gt;<a class="code" href="classDigitalOutput.html#51540582af4f1ebb04c19e0256e0cbfd">GetChannelForRouting</a>();
<a name="l00142"></a>00142         <a class="code" href="classSPI.html#400f5597cc5fa5d5ec4e53b16e7e563a">m_channels</a>.MOSI_Module = mosi-&gt;<a class="code" href="classDigitalOutput.html#a32b0d9370a8dca3970a09b38d0bb434">GetModuleForRouting</a>();
<a name="l00143"></a>00143     }
<a name="l00144"></a>00144     <span class="keywordflow">else</span>
<a name="l00145"></a>00145     {
<a name="l00146"></a>00146         <a class="code" href="classSPI.html#400f5597cc5fa5d5ec4e53b16e7e563a">m_channels</a>.MOSI_Channel = 0;
<a name="l00147"></a>00147         <a class="code" href="classSPI.html#400f5597cc5fa5d5ec4e53b16e7e563a">m_channels</a>.MOSI_Module = 0;
<a name="l00148"></a>00148     }
<a name="l00149"></a>00149 
<a name="l00150"></a>00150     <span class="keywordflow">if</span> (miso)
<a name="l00151"></a>00151     {
<a name="l00152"></a>00152         <a class="code" href="classSPI.html#400f5597cc5fa5d5ec4e53b16e7e563a">m_channels</a>.MISO_Channel = miso-&gt;<a class="code" href="classDigitalInput.html#040ad3adde43d5ca89cfde006513fdcd">GetChannelForRouting</a>();
<a name="l00153"></a>00153         <a class="code" href="classSPI.html#400f5597cc5fa5d5ec4e53b16e7e563a">m_channels</a>.MISO_Module = miso-&gt;<a class="code" href="classDigitalInput.html#4401dc554ebab68503196e596c58255e">GetModuleForRouting</a>();
<a name="l00154"></a>00154     }
<a name="l00155"></a>00155     <span class="keywordflow">else</span>
<a name="l00156"></a>00156     {
<a name="l00157"></a>00157         <a class="code" href="classSPI.html#400f5597cc5fa5d5ec4e53b16e7e563a">m_channels</a>.MISO_Channel = 0;
<a name="l00158"></a>00158         <a class="code" href="classSPI.html#400f5597cc5fa5d5ec4e53b16e7e563a">m_channels</a>.MISO_Module = 0;
<a name="l00159"></a>00159     }
<a name="l00160"></a>00160 
<a name="l00161"></a>00161     <a class="code" href="classSPI.html#bb5b7fdb1d7bd262f01f1955611dad04">m_ss</a> = <a class="code" href="nivision_8h.html#070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00162"></a>00162 }
<a name="l00163"></a>00163 
<a name="l00170"></a><a class="code" href="classSPI.html#f1d668c7056784c19d2d7b494e3c214a">00170</a> <span class="keywordtype">void</span> <a class="code" href="classSPI.html#f1d668c7056784c19d2d7b494e3c214a">SPI::SetBitsPerWord</a>(UINT32 bits)
<a name="l00171"></a>00171 {
<a name="l00172"></a>00172     <a class="code" href="classSPI.html#246566dd89a56e47235573fa1cbf4650">m_config</a>.BusBitWidth = bits;
<a name="l00173"></a>00173 }
<a name="l00174"></a>00174 
<a name="l00181"></a><a class="code" href="classSPI.html#6dea6f0679df0018fd19b52f0bb06347">00181</a> UINT32 <a class="code" href="classSPI.html#6dea6f0679df0018fd19b52f0bb06347">SPI::GetBitsPerWord</a>()
<a name="l00182"></a>00182 {
<a name="l00183"></a>00183     <span class="keywordflow">return</span> <a class="code" href="classSPI.html#246566dd89a56e47235573fa1cbf4650">m_config</a>.BusBitWidth;
<a name="l00184"></a>00184 }
<a name="l00185"></a>00185 
<a name="l00192"></a><a class="code" href="classSPI.html#27b450354fc78eb4441e7d59f8fe65f2">00192</a> <span class="keywordtype">void</span> <a class="code" href="classSPI.html#27b450354fc78eb4441e7d59f8fe65f2">SPI::SetClockRate</a>(<span class="keywordtype">double</span> hz)
<a name="l00193"></a>00193 {
<a name="l00194"></a>00194     <span class="keywordtype">int</span> delay = 0;
<a name="l00195"></a>00195     <span class="keywordflow">if</span> (hz &lt;= 76628.4)
<a name="l00196"></a>00196     {
<a name="l00197"></a>00197         <span class="keywordtype">double</span> v = (1.0/hz)/1.305e-5;
<a name="l00198"></a>00198         <span class="keywordtype">int</span> intv = (<a class="code" href="pcre_8h.html#0b3961ed46c71ba306a3b0012b038e34">int</a>)v;
<a name="l00199"></a>00199         <span class="keywordflow">if</span> (v-intv &gt; 0.5)
<a name="l00200"></a>00200             delay = intv;
<a name="l00201"></a>00201         <span class="keywordflow">else</span>
<a name="l00202"></a>00202             delay = intv-1;
<a name="l00203"></a>00203     }
<a name="l00204"></a>00204     <span class="keywordflow">if</span> (delay &gt; 255)
<a name="l00205"></a>00205     {
<a name="l00206"></a>00206         <a class="code" href="Utility_8h.html#3290d292094ffd3901e9b00db8049f0a">wpi_fatal</a>(SPIClockRateTooLow);
<a name="l00207"></a>00207         delay = 255;
<a name="l00208"></a>00208     }
<a name="l00209"></a>00209     <a class="code" href="classSPI.html#246566dd89a56e47235573fa1cbf4650">m_config</a>.ClockHalfPeriodDelay = delay;
<a name="l00210"></a>00210 }
<a name="l00211"></a>00211 
<a name="l00216"></a><a class="code" href="classSPI.html#66ed807d9a76400a74e815837b3ff32b">00216</a> <span class="keywordtype">void</span> <a class="code" href="classSPI.html#66ed807d9a76400a74e815837b3ff32b">SPI::SetMSBFirst</a>()
<a name="l00217"></a>00217 {
<a name="l00218"></a>00218     <a class="code" href="classSPI.html#246566dd89a56e47235573fa1cbf4650">m_config</a>.MSBfirst = 1;
<a name="l00219"></a>00219 }
<a name="l00220"></a>00220 
<a name="l00225"></a><a class="code" href="classSPI.html#cd12e6ca307ec0dc0fb80f4cc9aa6ee3">00225</a> <span class="keywordtype">void</span> <a class="code" href="classSPI.html#cd12e6ca307ec0dc0fb80f4cc9aa6ee3">SPI::SetLSBFirst</a>()
<a name="l00226"></a>00226 {
<a name="l00227"></a>00227     <a class="code" href="classSPI.html#246566dd89a56e47235573fa1cbf4650">m_config</a>.MSBfirst = 0;
<a name="l00228"></a>00228 }
<a name="l00229"></a>00229 
<a name="l00234"></a><a class="code" href="classSPI.html#463dc7cb26d0b865c44c73538bc23ae0">00234</a> <span class="keywordtype">void</span> <a class="code" href="classSPI.html#463dc7cb26d0b865c44c73538bc23ae0">SPI::SetSampleDataOnFalling</a>()
<a name="l00235"></a>00235 {
<a name="l00236"></a>00236     <a class="code" href="classSPI.html#246566dd89a56e47235573fa1cbf4650">m_config</a>.DataOnFalling = 1;
<a name="l00237"></a>00237 }
<a name="l00238"></a>00238 
<a name="l00243"></a><a class="code" href="classSPI.html#00eec7d4310c18e8cfb4b36592b488d9">00243</a> <span class="keywordtype">void</span> <a class="code" href="classSPI.html#00eec7d4310c18e8cfb4b36592b488d9">SPI::SetSampleDataOnRising</a>()
<a name="l00244"></a>00244 {
<a name="l00245"></a>00245     <a class="code" href="classSPI.html#246566dd89a56e47235573fa1cbf4650">m_config</a>.DataOnFalling = 0;
<a name="l00246"></a>00246 }
<a name="l00247"></a>00247 
<a name="l00259"></a><a class="code" href="classSPI.html#f0a6cd80fbc758c2a8e344f044e1a59d">00259</a> <span class="keywordtype">void</span> <a class="code" href="classSPI.html#f0a6cd80fbc758c2a8e344f044e1a59d">SPI::SetSlaveSelect</a>(<a class="code" href="classDigitalOutput.html">DigitalOutput</a> *ss, <a class="code" href="classSPI.html#f1cea550215b0e6c261465c7860d954e">tFrameMode</a> mode, <span class="keywordtype">bool</span> activeLow)
<a name="l00260"></a>00260 {
<a name="l00261"></a>00261     <span class="keywordflow">if</span> (ss)
<a name="l00262"></a>00262     {
<a name="l00263"></a>00263         <a class="code" href="classSPI.html#400f5597cc5fa5d5ec4e53b16e7e563a">m_channels</a>.SS_Channel = ss-&gt;<a class="code" href="classDigitalOutput.html#51540582af4f1ebb04c19e0256e0cbfd">GetChannelForRouting</a>();
<a name="l00264"></a>00264         <a class="code" href="classSPI.html#400f5597cc5fa5d5ec4e53b16e7e563a">m_channels</a>.SS_Module = ss-&gt;<a class="code" href="classDigitalOutput.html#a32b0d9370a8dca3970a09b38d0bb434">GetModuleForRouting</a>();
<a name="l00265"></a>00265     }
<a name="l00266"></a>00266     <span class="keywordflow">else</span>
<a name="l00267"></a>00267     {
<a name="l00268"></a>00268         <a class="code" href="classSPI.html#400f5597cc5fa5d5ec4e53b16e7e563a">m_channels</a>.SS_Channel = 0;
<a name="l00269"></a>00269         <a class="code" href="classSPI.html#400f5597cc5fa5d5ec4e53b16e7e563a">m_channels</a>.SS_Module = 0;
<a name="l00270"></a>00270     }
<a name="l00271"></a>00271     <a class="code" href="classSPI.html#bb5b7fdb1d7bd262f01f1955611dad04">m_ss</a> = ss;
<a name="l00272"></a>00272 
<a name="l00273"></a>00273     <span class="keywordflow">switch</span> (mode)
<a name="l00274"></a>00274     {
<a name="l00275"></a>00275         <span class="keywordflow">case</span> <a class="code" href="classSPI.html#f1cea550215b0e6c261465c7860d954e00966352d58db0b7dc4638828ffdbf2a">kChipSelect</a>:
<a name="l00276"></a>00276             <a class="code" href="classSPI.html#246566dd89a56e47235573fa1cbf4650">m_config</a>.LatchFirst = 0;
<a name="l00277"></a>00277             <a class="code" href="classSPI.html#246566dd89a56e47235573fa1cbf4650">m_config</a>.LatchLast = 0;
<a name="l00278"></a>00278             <span class="keywordflow">break</span>;
<a name="l00279"></a>00279         <span class="keywordflow">case</span> <a class="code" href="classSPI.html#f1cea550215b0e6c261465c7860d954e32d72891ae37fa63d0cda961aaf9e6c3">kPreLatchPulse</a>:
<a name="l00280"></a>00280             <a class="code" href="classSPI.html#246566dd89a56e47235573fa1cbf4650">m_config</a>.LatchFirst = 1;
<a name="l00281"></a>00281             <a class="code" href="classSPI.html#246566dd89a56e47235573fa1cbf4650">m_config</a>.LatchLast = 0;
<a name="l00282"></a>00282             <span class="keywordflow">break</span>;
<a name="l00283"></a>00283         <span class="keywordflow">case</span> <a class="code" href="classSPI.html#f1cea550215b0e6c261465c7860d954e976a899649814f50cbe4f6d06a2c4084">kPostLatchPulse</a>:
<a name="l00284"></a>00284             <a class="code" href="classSPI.html#246566dd89a56e47235573fa1cbf4650">m_config</a>.LatchFirst = 0;
<a name="l00285"></a>00285             <a class="code" href="classSPI.html#246566dd89a56e47235573fa1cbf4650">m_config</a>.LatchLast = 1;
<a name="l00286"></a>00286             <span class="keywordflow">break</span>;
<a name="l00287"></a>00287         <span class="keywordflow">case</span> <a class="code" href="classSPI.html#f1cea550215b0e6c261465c7860d954ea1d45507eb42a28189e349f2ad490089">kPreAndPostLatchPulse</a>:
<a name="l00288"></a>00288             <a class="code" href="classSPI.html#246566dd89a56e47235573fa1cbf4650">m_config</a>.LatchFirst = 1;
<a name="l00289"></a>00289             <a class="code" href="classSPI.html#246566dd89a56e47235573fa1cbf4650">m_config</a>.LatchLast = 1;
<a name="l00290"></a>00290             <span class="keywordflow">break</span>;
<a name="l00291"></a>00291     }
<a name="l00292"></a>00292 
<a name="l00293"></a>00293     <a class="code" href="classSPI.html#246566dd89a56e47235573fa1cbf4650">m_config</a>.FramePolarity = activeLow ? 1 : 0;
<a name="l00294"></a>00294 }
<a name="l00295"></a>00295 
<a name="l00307"></a><a class="code" href="classSPI.html#d2745d268c7350f65d4657b6d558a67a">00307</a> <span class="keywordtype">void</span> <a class="code" href="classSPI.html#f0a6cd80fbc758c2a8e344f044e1a59d">SPI::SetSlaveSelect</a>(<a class="code" href="classDigitalOutput.html">DigitalOutput</a> &amp;ss, <a class="code" href="classSPI.html#f1cea550215b0e6c261465c7860d954e">tFrameMode</a> mode, <span class="keywordtype">bool</span> activeLow)
<a name="l00308"></a>00308 {
<a name="l00309"></a>00309     <a class="code" href="classSPI.html#f0a6cd80fbc758c2a8e344f044e1a59d">SetSlaveSelect</a>(&amp;ss, mode, activeLow);
<a name="l00310"></a>00310 }
<a name="l00311"></a>00311 
<a name="l00323"></a><a class="code" href="classSPI.html#614dfabba0dcbb66d6c1a88ba40bd26c">00323</a> <a class="code" href="classDigitalOutput.html">DigitalOutput</a> *<a class="code" href="classSPI.html#614dfabba0dcbb66d6c1a88ba40bd26c">SPI::GetSlaveSelect</a>(<a class="code" href="classSPI.html#f1cea550215b0e6c261465c7860d954e">tFrameMode</a> *mode, <span class="keywordtype">bool</span> *activeLow)
<a name="l00324"></a>00324 {
<a name="l00325"></a>00325     <span class="keywordflow">if</span> (mode != <a class="code" href="nivision_8h.html#070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00326"></a>00326     {
<a name="l00327"></a>00327         *mode = (<a class="code" href="classSPI.html#f1cea550215b0e6c261465c7860d954e">tFrameMode</a>) (<a class="code" href="classSPI.html#246566dd89a56e47235573fa1cbf4650">m_config</a>.LatchFirst | (<a class="code" href="classSPI.html#246566dd89a56e47235573fa1cbf4650">m_config</a>.LatchLast &lt;&lt; 1));
<a name="l00328"></a>00328     }
<a name="l00329"></a>00329     <span class="keywordflow">if</span> (activeLow != <a class="code" href="nivision_8h.html#070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00330"></a>00330     {
<a name="l00331"></a>00331         *activeLow = <a class="code" href="classSPI.html#246566dd89a56e47235573fa1cbf4650">m_config</a>.FramePolarity != 0;
<a name="l00332"></a>00332     }
<a name="l00333"></a>00333     <span class="keywordflow">return</span> <a class="code" href="classSPI.html#bb5b7fdb1d7bd262f01f1955611dad04">m_ss</a>;
<a name="l00334"></a>00334 }
<a name="l00335"></a>00335 
<a name="l00340"></a><a class="code" href="classSPI.html#a1b8cb48216e0a502bb34486636da047">00340</a> <span class="keywordtype">void</span> <a class="code" href="classSPI.html#a1b8cb48216e0a502bb34486636da047">SPI::SetClockActiveLow</a>()
<a name="l00341"></a>00341 {
<a name="l00342"></a>00342     <a class="code" href="classSPI.html#246566dd89a56e47235573fa1cbf4650">m_config</a>.ClockPolarity = 1;
<a name="l00343"></a>00343 }
<a name="l00344"></a>00344 
<a name="l00349"></a><a class="code" href="classSPI.html#5581a5f70c8e49dd712d44f40ee81e6f">00349</a> <span class="keywordtype">void</span> <a class="code" href="classSPI.html#5581a5f70c8e49dd712d44f40ee81e6f">SPI::SetClockActiveHigh</a>()
<a name="l00350"></a>00350 {
<a name="l00351"></a>00351     <a class="code" href="classSPI.html#246566dd89a56e47235573fa1cbf4650">m_config</a>.ClockPolarity = 0;
<a name="l00352"></a>00352 }
<a name="l00353"></a>00353 
<a name="l00357"></a><a class="code" href="classSPI.html#660a95177a0e69be2ae3b0f5ace85d2c">00357</a> <span class="keywordtype">void</span> <a class="code" href="classSPI.html#660a95177a0e69be2ae3b0f5ace85d2c">SPI::ApplyConfig</a>()
<a name="l00358"></a>00358 {
<a name="l00359"></a>00359     <a class="code" href="classSynchronized.html">Synchronized</a> sync(<a class="code" href="classSPI.html#5526fc62f7ed652c65ab9e4a5f778062">m_semaphore</a>);
<a name="l00360"></a>00360 
<a name="l00361"></a>00361     <a class="code" href="classSPI.html#2e51fd2a5f60a207e1948fcce6ce4b6a">m_spi</a>-&gt;writeConfig(<a class="code" href="classSPI.html#246566dd89a56e47235573fa1cbf4650">m_config</a>, &amp;<a class="code" href="classErrorBase.html#94cef1c4df1d6def498a2b3c458408c4">status</a>);
<a name="l00362"></a>00362     <a class="code" href="classSPI.html#2e51fd2a5f60a207e1948fcce6ce4b6a">m_spi</a>-&gt;writeChannels(<a class="code" href="classSPI.html#400f5597cc5fa5d5ec4e53b16e7e563a">m_channels</a>, &amp;<a class="code" href="classErrorBase.html#94cef1c4df1d6def498a2b3c458408c4">status</a>);
<a name="l00363"></a>00363     <a class="code" href="classSPI.html#2e51fd2a5f60a207e1948fcce6ce4b6a">m_spi</a>-&gt;strobeReset(&amp;<a class="code" href="classErrorBase.html#94cef1c4df1d6def498a2b3c458408c4">status</a>);
<a name="l00364"></a>00364     <a class="code" href="Utility_8h.html#8dd3b031e36607585b844aef60f80f6d">wpi_assertCleanStatus</a>(<a class="code" href="classErrorBase.html#94cef1c4df1d6def498a2b3c458408c4">status</a>);
<a name="l00365"></a>00365 }
<a name="l00366"></a>00366 
<a name="l00373"></a><a class="code" href="classSPI.html#9154529287b4995e403ed110e76963cd">00373</a> UINT16 <a class="code" href="classSPI.html#9154529287b4995e403ed110e76963cd">SPI::GetOutputFIFOAvailable</a>()
<a name="l00374"></a>00374 {
<a name="l00375"></a>00375     UINT16 result = <a class="code" href="classSPI.html#2e51fd2a5f60a207e1948fcce6ce4b6a">m_spi</a>-&gt;readAvailableToLoad(&amp;<a class="code" href="classErrorBase.html#94cef1c4df1d6def498a2b3c458408c4">status</a>);
<a name="l00376"></a>00376     <a class="code" href="Utility_8h.html#8dd3b031e36607585b844aef60f80f6d">wpi_assertCleanStatus</a>(<a class="code" href="classErrorBase.html#94cef1c4df1d6def498a2b3c458408c4">status</a>);
<a name="l00377"></a>00377     <span class="keywordflow">return</span> result;
<a name="l00378"></a>00378 }
<a name="l00379"></a>00379 
<a name="l00386"></a><a class="code" href="classSPI.html#b4de7fc2759b427c33af1aa0d79b1973">00386</a> UINT16 <a class="code" href="classSPI.html#b4de7fc2759b427c33af1aa0d79b1973">SPI::GetNumReceived</a>()
<a name="l00387"></a>00387 {
<a name="l00388"></a>00388     UINT16 result = <a class="code" href="classSPI.html#2e51fd2a5f60a207e1948fcce6ce4b6a">m_spi</a>-&gt;readReceivedElements(&amp;<a class="code" href="classErrorBase.html#94cef1c4df1d6def498a2b3c458408c4">status</a>);
<a name="l00389"></a>00389     <a class="code" href="Utility_8h.html#8dd3b031e36607585b844aef60f80f6d">wpi_assertCleanStatus</a>(<a class="code" href="classErrorBase.html#94cef1c4df1d6def498a2b3c458408c4">status</a>);
<a name="l00390"></a>00390     <span class="keywordflow">return</span> result;
<a name="l00391"></a>00391 }
<a name="l00392"></a>00392 
<a name="l00398"></a><a class="code" href="classSPI.html#88ae50d03a0aeecac3045a4d5ca7fb81">00398</a> <span class="keywordtype">bool</span> <a class="code" href="classSPI.html#88ae50d03a0aeecac3045a4d5ca7fb81">SPI::IsDone</a>()
<a name="l00399"></a>00399 {
<a name="l00400"></a>00400     <span class="keywordtype">bool</span> result = <a class="code" href="classSPI.html#2e51fd2a5f60a207e1948fcce6ce4b6a">m_spi</a>-&gt;readStatus_Idle(&amp;<a class="code" href="classErrorBase.html#94cef1c4df1d6def498a2b3c458408c4">status</a>);
<a name="l00401"></a>00401     <a class="code" href="Utility_8h.html#8dd3b031e36607585b844aef60f80f6d">wpi_assertCleanStatus</a>(<a class="code" href="classErrorBase.html#94cef1c4df1d6def498a2b3c458408c4">status</a>);
<a name="l00402"></a>00402     <span class="keywordflow">return</span> result;
<a name="l00403"></a>00403 }
<a name="l00404"></a>00404 
<a name="l00411"></a><a class="code" href="classSPI.html#ec0f909f191fec08bb1a069bdb35fd8e">00411</a> <span class="keywordtype">bool</span> <a class="code" href="classSPI.html#ec0f909f191fec08bb1a069bdb35fd8e">SPI::HadReceiveOverflow</a>()
<a name="l00412"></a>00412 {
<a name="l00413"></a>00413     <span class="keywordtype">bool</span> result = <a class="code" href="classSPI.html#2e51fd2a5f60a207e1948fcce6ce4b6a">m_spi</a>-&gt;readStatus_ReceivedDataOverflow(&amp;<a class="code" href="classErrorBase.html#94cef1c4df1d6def498a2b3c458408c4">status</a>);
<a name="l00414"></a>00414     <a class="code" href="Utility_8h.html#8dd3b031e36607585b844aef60f80f6d">wpi_assertCleanStatus</a>(<a class="code" href="classErrorBase.html#94cef1c4df1d6def498a2b3c458408c4">status</a>);
<a name="l00415"></a>00415     <span class="keywordflow">return</span> result;
<a name="l00416"></a>00416 }
<a name="l00417"></a>00417 
<a name="l00425"></a><a class="code" href="classSPI.html#231184061058fc3924e0d5e3abb0dcb1">00425</a> <span class="keywordtype">void</span> <a class="code" href="classSPI.html#231184061058fc3924e0d5e3abb0dcb1">SPI::Write</a>(UINT32 data)
<a name="l00426"></a>00426 {
<a name="l00427"></a>00427     <span class="keywordflow">if</span> (<a class="code" href="classSPI.html#400f5597cc5fa5d5ec4e53b16e7e563a">m_channels</a>.MOSI_Channel == 0 &amp;&amp; <a class="code" href="classSPI.html#400f5597cc5fa5d5ec4e53b16e7e563a">m_channels</a>.MOSI_Module == 0)
<a name="l00428"></a>00428     {
<a name="l00429"></a>00429         <a class="code" href="Utility_8h.html#3290d292094ffd3901e9b00db8049f0a">wpi_fatal</a>(SPIWriteNoMOSI);
<a name="l00430"></a>00430         <span class="keywordflow">return</span>;
<a name="l00431"></a>00431     }
<a name="l00432"></a>00432 
<a name="l00433"></a>00433     <a class="code" href="classSynchronized.html">Synchronized</a> sync(<a class="code" href="classSPI.html#5526fc62f7ed652c65ab9e4a5f778062">m_semaphore</a>);
<a name="l00434"></a>00434 
<a name="l00435"></a>00435     <span class="keywordflow">while</span> (<a class="code" href="classSPI.html#9154529287b4995e403ed110e76963cd">GetOutputFIFOAvailable</a>() == 0)
<a name="l00436"></a>00436         taskDelay(NO_WAIT);
<a name="l00437"></a>00437 
<a name="l00438"></a>00438     <a class="code" href="classSPI.html#2e51fd2a5f60a207e1948fcce6ce4b6a">m_spi</a>-&gt;writeDataToLoad(data, &amp;<a class="code" href="classErrorBase.html#94cef1c4df1d6def498a2b3c458408c4">status</a>);
<a name="l00439"></a>00439     <a class="code" href="classSPI.html#2e51fd2a5f60a207e1948fcce6ce4b6a">m_spi</a>-&gt;strobeLoad(&amp;<a class="code" href="classErrorBase.html#94cef1c4df1d6def498a2b3c458408c4">status</a>);
<a name="l00440"></a>00440     <a class="code" href="Utility_8h.html#8dd3b031e36607585b844aef60f80f6d">wpi_assertCleanStatus</a>(<a class="code" href="classErrorBase.html#94cef1c4df1d6def498a2b3c458408c4">status</a>);
<a name="l00441"></a>00441 }
<a name="l00442"></a>00442 
<a name="l00456"></a><a class="code" href="classSPI.html#748b582c349402ddc4ea0fb0034b00b3">00456</a> UINT32 <a class="code" href="classSPI.html#748b582c349402ddc4ea0fb0034b00b3">SPI::Read</a>(<span class="keywordtype">bool</span> initiate)
<a name="l00457"></a>00457 {
<a name="l00458"></a>00458     <span class="keywordflow">if</span> (<a class="code" href="classSPI.html#400f5597cc5fa5d5ec4e53b16e7e563a">m_channels</a>.MISO_Channel == 0 &amp;&amp; <a class="code" href="classSPI.html#400f5597cc5fa5d5ec4e53b16e7e563a">m_channels</a>.MISO_Module == 0)
<a name="l00459"></a>00459     {
<a name="l00460"></a>00460         <a class="code" href="Utility_8h.html#3290d292094ffd3901e9b00db8049f0a">wpi_fatal</a>(SPIReadNoMISO);
<a name="l00461"></a>00461         <span class="keywordflow">return</span> 0;
<a name="l00462"></a>00462     }
<a name="l00463"></a>00463 
<a name="l00464"></a>00464     <a class="code" href="classSynchronized.html">Synchronized</a> sync(<a class="code" href="classSPI.html#5526fc62f7ed652c65ab9e4a5f778062">m_semaphore</a>);
<a name="l00465"></a>00465 
<a name="l00466"></a>00466     <span class="keywordflow">if</span> (initiate)
<a name="l00467"></a>00467     {
<a name="l00468"></a>00468         <a class="code" href="classSPI.html#2e51fd2a5f60a207e1948fcce6ce4b6a">m_spi</a>-&gt;writeDataToLoad(0, &amp;<a class="code" href="classErrorBase.html#94cef1c4df1d6def498a2b3c458408c4">status</a>);
<a name="l00469"></a>00469         <a class="code" href="classSPI.html#2e51fd2a5f60a207e1948fcce6ce4b6a">m_spi</a>-&gt;strobeLoad(&amp;<a class="code" href="classErrorBase.html#94cef1c4df1d6def498a2b3c458408c4">status</a>);
<a name="l00470"></a>00470         <a class="code" href="Utility_8h.html#8dd3b031e36607585b844aef60f80f6d">wpi_assertCleanStatus</a>(<a class="code" href="classErrorBase.html#94cef1c4df1d6def498a2b3c458408c4">status</a>);
<a name="l00471"></a>00471     }
<a name="l00472"></a>00472 
<a name="l00473"></a>00473     <span class="comment">// Do we have anything ready to read?</span>
<a name="l00474"></a>00474     <span class="keywordflow">if</span> (<a class="code" href="classSPI.html#b4de7fc2759b427c33af1aa0d79b1973">GetNumReceived</a>() == 0)
<a name="l00475"></a>00475     {
<a name="l00476"></a>00476         <span class="keywordflow">if</span> (!initiate &amp;&amp; <a class="code" href="classSPI.html#88ae50d03a0aeecac3045a4d5ca7fb81">IsDone</a>() &amp;&amp; <a class="code" href="classSPI.html#9154529287b4995e403ed110e76963cd">GetOutputFIFOAvailable</a>() == <a class="code" href="classSPI.html#02aeb16b20e053684835ee32be95ea04edd1997fdc34beadfe77f098b2c30b5c">kTransmitFIFODepth</a>)
<a name="l00477"></a>00477         {
<a name="l00478"></a>00478             <span class="comment">// Nothing to read: error out</span>
<a name="l00479"></a>00479             <a class="code" href="Utility_8h.html#3290d292094ffd3901e9b00db8049f0a">wpi_fatal</a>(SPIReadNoData);
<a name="l00480"></a>00480             <span class="keywordflow">return</span> 0;
<a name="l00481"></a>00481         }
<a name="l00482"></a>00482 
<a name="l00483"></a>00483         <span class="comment">// Wait for the transaction to complete</span>
<a name="l00484"></a>00484         <span class="keywordflow">while</span> (<a class="code" href="classSPI.html#b4de7fc2759b427c33af1aa0d79b1973">GetNumReceived</a>() == 0)
<a name="l00485"></a>00485             taskDelay(NO_WAIT);
<a name="l00486"></a>00486     }
<a name="l00487"></a>00487 
<a name="l00488"></a>00488     <a class="code" href="classSPI.html#2e51fd2a5f60a207e1948fcce6ce4b6a">m_spi</a>-&gt;strobeReadReceivedData(&amp;<a class="code" href="classErrorBase.html#94cef1c4df1d6def498a2b3c458408c4">status</a>);
<a name="l00489"></a>00489     UINT32 data = <a class="code" href="classSPI.html#2e51fd2a5f60a207e1948fcce6ce4b6a">m_spi</a>-&gt;readReceivedData(&amp;<a class="code" href="classErrorBase.html#94cef1c4df1d6def498a2b3c458408c4">status</a>);
<a name="l00490"></a>00490     <a class="code" href="Utility_8h.html#8dd3b031e36607585b844aef60f80f6d">wpi_assertCleanStatus</a>(<a class="code" href="classErrorBase.html#94cef1c4df1d6def498a2b3c458408c4">status</a>);
<a name="l00491"></a>00491 
<a name="l00492"></a>00492     <span class="keywordflow">return</span> data;
<a name="l00493"></a>00493 }
<a name="l00494"></a>00494 
<a name="l00498"></a><a class="code" href="classSPI.html#19bcc2d6206a4c54a62cd0a358ef1d1a">00498</a> <span class="keywordtype">void</span> <a class="code" href="classSPI.html#19bcc2d6206a4c54a62cd0a358ef1d1a">SPI::Reset</a>()
<a name="l00499"></a>00499 {
<a name="l00500"></a>00500     <a class="code" href="classSPI.html#2e51fd2a5f60a207e1948fcce6ce4b6a">m_spi</a>-&gt;strobeReset(&amp;<a class="code" href="classErrorBase.html#94cef1c4df1d6def498a2b3c458408c4">status</a>);
<a name="l00501"></a>00501     <a class="code" href="Utility_8h.html#8dd3b031e36607585b844aef60f80f6d">wpi_assertCleanStatus</a>(<a class="code" href="classErrorBase.html#94cef1c4df1d6def498a2b3c458408c4">status</a>);
<a name="l00502"></a>00502 }
<a name="l00503"></a>00503 
<a name="l00507"></a><a class="code" href="classSPI.html#e70ffd5d8cd8f973b9fc2103d2ee3474">00507</a> <span class="keywordtype">void</span> <a class="code" href="classSPI.html#e70ffd5d8cd8f973b9fc2103d2ee3474">SPI::ClearReceivedData</a>()
<a name="l00508"></a>00508 {
<a name="l00509"></a>00509     <a class="code" href="classSPI.html#2e51fd2a5f60a207e1948fcce6ce4b6a">m_spi</a>-&gt;strobeClearReceivedData(&amp;<a class="code" href="classErrorBase.html#94cef1c4df1d6def498a2b3c458408c4">status</a>);
<a name="l00510"></a>00510     <a class="code" href="Utility_8h.html#8dd3b031e36607585b844aef60f80f6d">wpi_assertCleanStatus</a>(<a class="code" href="classErrorBase.html#94cef1c4df1d6def498a2b3c458408c4">status</a>);
<a name="l00511"></a>00511 }
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Wed Feb 9 11:20:44 2011 for WPILIB by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
